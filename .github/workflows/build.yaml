---
# Reusable workflow for building SpdxTool artifacts
# This workflow is called by other workflows to build the project
on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
    secrets:
      SONAR_TOKEN:
        required: true


jobs:
  # Performs quick quality checks for project formatting consistency including
  # markdown linting, spell checking, and YAML validation.
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.x

      - name: Restore Tools
        run: >
          dotnet tool restore

      - name: Capture tool versions
        shell: bash
        run: |
          echo "Capturing tool versions..."
          dotnet versionmark --capture --job-id "quality" -- dotnet git versionmark
          echo "✓ Tool versions captured"

      - name: Upload version capture
        uses: actions/upload-artifact@v6
        with:
          name: version-capture-quality
          path: versionmark-quality.json

      - name: Spell Check
        uses: streetsidesoftware/cspell-action@v8
        with:
          config: .cspell.json
          incremental_files_only: false
          files: |
            **/*.md
            **/*.cs
            **/*.yaml
            **/*.yml

      - name: Markdown Lint
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          config: .markdownlint-cli2.jsonc
          globs: '**/*.md'

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint.yaml

  # Builds and unit-tests the project on supported operating systems to ensure
  # unit-tests operate on all platforms and to run SonarScanner for generating
  # the code quality report.
  build:
    name: Build ${{ matrix.os }}
    needs: quality-checks
    permissions:
      contents: read        # To read repository contents
      pull-requests: write  # To write pull requests analysis

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x

      - name: Restore Tools
        run: >
          dotnet tool restore

      - name: Restore Dependencies
        run: >
          dotnet restore

      - name: Start Sonar Scanner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          dotnet dotnet-sonarscanner
          begin
          /k:"demaconsulting_SpdxTool"
          /o:"demaconsulting"
          /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
          /d:sonar.host.url="https://sonarcloud.io"
          /d:sonar.cs.opencover.reportsPaths=**/*.opencover.xml
          /d:sonar.scanner.scanAll=false

      - name: Build
        run: >
          dotnet build
          --no-restore
          --configuration Release
          --property:Version=${{ inputs.version }}

      - name: Test
        run: >
          dotnet test
          --no-build
          --configuration Release
          --property:Version=${{ inputs.version }}
          --collect "XPlat Code Coverage;Format=opencover"
          --logger "trx;LogFilePrefix=${{ matrix.os }}"
          --results-directory test-results

      - name: End Sonar Scanner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          dotnet dotnet-sonarscanner
          end
          /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      - name: Create Dotnet Tool
        run: >
          dotnet pack
          --no-build
          --no-restore
          --property:PackageVersion=${{ inputs.version }}

      - name: Capture tool versions
        shell: bash
        run: |
          echo "Capturing tool versions..."
          # Create short job ID: build-win, build-ubuntu
          OS_SHORT=$(echo "${{ matrix.os }}" | sed 's/windows-latest/win/;s/ubuntu-latest/ubuntu/')
          JOB_ID="build-${OS_SHORT}"
          dotnet versionmark --capture --job-id "${JOB_ID}" -- \
            dotnet git dotnet-sonarscanner versionmark
          echo "✓ Tool versions captured"

      - name: Upload version capture
        uses: actions/upload-artifact@v6
        with:
          name: version-capture-${{ matrix.os }}
          path: versionmark-build-*.json

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        with:
          name: test-results-${{ matrix.os }}
          path: test-results/*.trx

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: artifacts-${{ matrix.os }}
          path: |
            src/DemaConsulting.SpdxTool/bin/Release/*.nupkg
            src/DemaConsulting.SpdxTool/bin/Release/*.snupkg
            src/DemaConsulting.SpdxTool.Targets/bin/Release/*.nupkg

  # Runs CodeQL security and quality analysis, gathering results to include
  # in the code quality report.
  codeql:
    name: CodeQL Analysis
    needs: quality-checks
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: csharp
          queries: security-and-quality
          config-file: ./.github/codeql-config.yml
          build-mode: manual

      - name: Restore Tools
        run: >
          dotnet tool restore

      - name: Restore Dependencies
        run: >
          dotnet restore

      - name: Build
        run: >
          dotnet build
          --no-restore
          --configuration Release
          --property:Version=${{ inputs.version }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:csharp"
          output: sarif-results
          upload: false

      - name: Upload SARIF
        uses: actions/upload-artifact@v6
        with:
          name: codeql-sarif
          path: sarif-results/csharp.sarif

  # Performs integration testing on a matrix of operating systems and .NET runtimes,
  # involving basic tool execution and running self-validation to ensure compatibility
  # across different platforms and runtime versions.
  integration-test:
    name: Integration Test ${{ matrix.os }} .NET ${{ matrix.dotnet-version }}
    runs-on: ${{ matrix.os }}
    needs: build
    permissions:
      contents: read

    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
        dotnet-version: ['8.x', '9.x', '10.x']

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            .versionmark.yaml
            .config/dotnet-tools.json

      - name: Download package
        uses: actions/download-artifact@v7
        with:
          name: artifacts-${{ matrix.os }}
          path: packages

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Restore Tools
        run: >
          dotnet tool restore

      - name: Install tool from package
        shell: bash
        run: |
          echo "Installing package version ${{ inputs.version }} from: packages/"
          dotnet tool install --global \
            --add-source packages \
            --version ${{ inputs.version }} \
            DemaConsulting.SpdxTool

      - name: Test version display
        shell: bash
        run: |
          echo "Testing spdx-tool --version..."
          spdx-tool --version || { echo "✗ Version command failed"; exit 1; }
          echo "✓ Version command succeeded"

      - name: Test help display
        shell: bash
        run: |
          echo "Testing spdx-tool --help..."
          spdx-tool --help || { echo "✗ Help command failed"; exit 1; }
          echo "✓ Help command succeeded"

      - name: Run self-validation
        shell: bash
        run: |
          echo "Running self-validation..."
          spdx-tool --validate --result \
            validation-${{ matrix.os }}-dotnet${{ matrix.dotnet-version }}.trx \
            || { echo "✗ Self-validation failed"; exit 1; }
          echo "✓ Self-validation succeeded"

      - name: Capture tool versions
        shell: bash
        run: |
          echo "Capturing tool versions..."
          # Create short job ID: int-win-8, int-win-9, int-ubuntu-8, etc.
          OS_SHORT=$(echo "${{ matrix.os }}" | sed 's/windows-latest/win/;s/ubuntu-latest/ubuntu/')
          DOTNET_SHORT=$(echo "${{ matrix.dotnet-version }}" | sed 's/\.x$//')
          JOB_ID="int-${OS_SHORT}-${DOTNET_SHORT}"
          dotnet versionmark --capture --job-id "${JOB_ID}" -- dotnet git versionmark
          echo "✓ Tool versions captured"

      - name: Upload version capture
        uses: actions/upload-artifact@v6
        with:
          name: version-capture-${{ matrix.os }}-dotnet${{ matrix.dotnet-version }}
          path: versionmark-int-*.json

      - name: Upload validation test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: validation-test-results-${{ matrix.os }}-dotnet${{ matrix.dotnet-version }}
          path: validation-${{ matrix.os }}-dotnet${{ matrix.dotnet-version }}.trx

  # Performs integration testing of the DemaConsulting.SpdxTool.Targets package
  # to verify the MSBuild targets work correctly with both single-TFM and
  # multi-TFM projects on Windows and Linux.
  targets-integration-test:
    name: Targets Test ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: build
    permissions:
      contents: read

    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download package
        uses: actions/download-artifact@v7
        with:
          name: artifacts-${{ matrix.os }}
          path: packages

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x

      - name: Install spdx-tool from package
        shell: bash
        run: |
          echo "Installing spdx-tool version ${{ inputs.version }}..."
          dotnet tool install --global \
            --add-source packages \
            --version ${{ inputs.version }} \
            DemaConsulting.SpdxTool
          echo "✓ spdx-tool installed"

      - name: Test single-TFM fixture with decoration
        shell: bash
        run: |
          echo "Testing single-TFM project with DecorateSBOM=true..."
          dotnet pack test/TestFixtures/SingleTfmProject/SingleTfmProject.csproj \
            --configuration Release \
            | tee single-tfm-output.txt
          grep -q "SpdxTool: SBOM decoration complete" single-tfm-output.txt \
            || { echo "✗ SBOM decoration did not run"; exit 1; }
          echo "✓ Single-TFM decoration succeeded"

      - name: Test multi-TFM fixture with decoration
        shell: bash
        run: |
          echo "Testing multi-TFM project with DecorateSBOM=true..."
          dotnet pack test/TestFixtures/MultiTfmProject/MultiTfmProject.csproj \
            --configuration Release \
            | tee multi-tfm-output.txt
          grep -q "SpdxTool: SBOM decoration complete" multi-tfm-output.txt \
            || { echo "✗ SBOM decoration did not run"; exit 1; }
          echo "✓ Multi-TFM decoration succeeded"

      - name: Test DecorateSBOM=false skips decoration
        shell: bash
        run: |
          echo "Testing DecorateSBOM=false..."
          dotnet pack test/TestFixtures/SingleTfmProject/SingleTfmProject.csproj \
            --configuration Release \
            /p:DecorateSBOM=false \
            | tee opt-out-output.txt
          if grep -q "SpdxTool: Decorating SBOM" opt-out-output.txt; then
            echo "✗ Decoration should not run when DecorateSBOM=false"
            exit 1
          fi
          echo "✓ Decoration correctly skipped"

      - name: Test missing workflow file produces error
        shell: bash
        run: |
          echo "Testing missing workflow file..."
          if dotnet pack test/TestFixtures/SingleTfmProject/SingleTfmProject.csproj \
            --configuration Release \
            /p:SpdxWorkflowFile=nonexistent-workflow.yaml 2>&1 \
            | tee missing-workflow-output.txt; then
            echo "✗ Pack should have failed with missing workflow"
            exit 1
          fi
          grep -q "SpdxTool workflow file not found" missing-workflow-output.txt \
            || { echo "✗ Expected clear error about missing workflow"; exit 1; }
          echo "✓ Missing workflow produces clear error"

  # Builds the supporting documentation including user guides, code quality
  # reports, and build notes.
  build-docs:
    name: Build Documents
    runs-on: windows-latest

    needs: [build, integration-test, targets-integration-test, codeql]

    permissions:
      contents: read

    steps:
      # === CHECKOUT AND DOWNLOAD ARTIFACTS ===
      # This section retrieves the code and all necessary artifacts from previous jobs.
      # Downstream projects: Add any additional artifact downloads here.

      - name: Checkout
        uses: actions/checkout@v6

      - name: Download all test results
        uses: actions/download-artifact@v7
        with:
          path: test-results
          pattern: '*test-results*'
        continue-on-error: true

      - name: Download CodeQL SARIF
        uses: actions/download-artifact@v7
        with:
          name: codeql-sarif
          path: codeql-results

      - name: Download all version captures
        uses: actions/download-artifact@v7
        with:
          path: version-captures
          pattern: 'version-capture-*'
        continue-on-error: true

      # === INSTALL DEPENDENCIES ===
      # This section installs all required dependencies and tools for document generation.
      # Downstream projects: Add any additional dependency installations here.

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.x'

      - name: Install npm dependencies
        run: >
          npm install

      - name: Restore Tools
        run: >
          dotnet tool restore

      # === CAPTURE TOOL VERSIONS ===
      # This section captures the versions of all tools used in the build process.
      # Downstream projects: Add any additional tools to capture here.

      - name: Capture tool versions for build-docs
        shell: bash
        run: |
          echo "Capturing tool versions..."
          dotnet versionmark --capture --job-id "build-docs" -- \
            dotnet git node npm pandoc weasyprint sarifmark sonarmark reqstream buildmark versionmark
          echo "✓ Tool versions captured"

      # === GENERATE MARKDOWN REPORTS ===
      # This section generates all markdown reports from various tools and sources.
      # Downstream projects: Add any additional markdown report generation steps here.

      - name: Generate Requirements, Justifications, and Trace Matrix with ReqStream
        # Note: --enforce fails the build if any requirement has no passing test evidence
        run: >
          dotnet reqstream
          --requirements requirements.yaml
          --tests "test-results/**/*.trx"
          --report docs/requirements/requirements.md
          --justifications docs/justifications/justifications.md
          --matrix docs/tracematrix/tracematrix.md
          --enforce

      - name: Generate CodeQL Quality Report with SarifMark
        run: >
          dotnet sarifmark
          --sarif codeql-results/csharp.sarif
          --report docs/quality/codeql-quality.md
          --heading "SpdxTool CodeQL Analysis"
          --report-depth 1

      - name: Display CodeQL Quality Report
        shell: bash
        run: |
          echo "=== CodeQL Quality Report ==="
          cat docs/quality/codeql-quality.md

      - name: Generate Code Quality Report with SonarMark
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: >
          dotnet sonarmark
          --server https://sonarcloud.io
          --project-key demaconsulting_SpdxTool
          --branch ${{ github.ref_name }}
          --token "$SONAR_TOKEN"
          --report docs/quality/sonar-quality.md
          --report-depth 1

      - name: Display SonarCloud Quality Report
        shell: bash
        run: |
          echo "=== SonarCloud Quality Report ==="
          cat docs/quality/sonar-quality.md

      - name: Generate Build Notes with BuildMark
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          dotnet buildmark
          --build-version ${{ inputs.version }}
          --report docs/buildnotes.md
          --report-depth 1

      - name: Display Build Notes Report
        shell: bash
        run: |
          echo "=== Build Notes Report ==="
          cat docs/buildnotes.md

      - name: Publish Tool Versions
        shell: bash
        run: |
          echo "Publishing tool versions..."
          dotnet versionmark --publish --report docs/buildnotes/versions.md --report-depth 1 \
            -- "versionmark-*.json" "version-captures/**/versionmark-*.json"
          echo "✓ Tool versions published"

      - name: Display Tool Versions Report
        shell: bash
        run: |
          echo "=== Tool Versions Report ==="
          cat docs/buildnotes/versions.md

      # === GENERATE HTML DOCUMENTS WITH PANDOC ===
      # This section converts markdown documents to HTML using Pandoc.
      # Downstream projects: Add any additional Pandoc HTML generation steps here.

      - name: Generate Build Notes HTML with Pandoc
        shell: bash
        run: >
          dotnet pandoc
          --defaults docs/buildnotes/definition.yaml
          --filter node_modules/.bin/mermaid-filter.cmd
          --metadata version="${{ inputs.version }}"
          --metadata date="$(date +'%Y-%m-%d')"
          --output docs/buildnotes/buildnotes.html

      - name: Generate Guide HTML with Pandoc
        shell: bash
        run: >
          dotnet pandoc
          --defaults docs/guide/definition.yaml
          --filter node_modules/.bin/mermaid-filter.cmd
          --metadata version="${{ inputs.version }}"
          --metadata date="$(date +'%Y-%m-%d')"
          --output docs/guide/guide.html

      - name: Generate Code Quality HTML with Pandoc
        shell: bash
        run: >
          dotnet pandoc
          docs/quality/title.txt
          --defaults docs/quality/definition.yaml
          --metadata version="${{ inputs.version }}"
          --metadata date="$(date +'%Y-%m-%d')"
          --output docs/quality/quality.html

      - name: Generate Requirements HTML with Pandoc
        shell: bash
        run: >
          dotnet pandoc
          --defaults docs/requirements/definition.yaml
          --metadata version="${{ inputs.version }}"
          --metadata date="$(date +'%Y-%m-%d')"
          --output docs/requirements/requirements.html

      - name: Generate Requirements Justifications HTML with Pandoc
        shell: bash
        run: >
          dotnet pandoc
          --defaults docs/justifications/definition.yaml
          --metadata version="${{ inputs.version }}"
          --metadata date="$(date +'%Y-%m-%d')"
          --output docs/justifications/justifications.html

      - name: Generate Trace Matrix HTML with Pandoc
        shell: bash
        run: >
          dotnet pandoc
          --defaults docs/tracematrix/definition.yaml
          --metadata version="${{ inputs.version }}"
          --metadata date="$(date +'%Y-%m-%d')"
          --output docs/tracematrix/tracematrix.html

      # === GENERATE PDF DOCUMENTS WITH WEASYPRINT ===
      # This section converts HTML documents to PDF using Weasyprint.
      # Downstream projects: Add any additional Weasyprint PDF generation steps here.

      - name: Generate Build Notes PDF with Weasyprint
        run: >
          dotnet weasyprint
          --pdf-variant pdf/a-3u
          docs/buildnotes/buildnotes.html
          "docs/SpdxTool Build Notes.pdf"

      - name: Generate Guide PDF with Weasyprint
        run: >
          dotnet weasyprint
          --pdf-variant pdf/a-3u
          docs/guide/guide.html
          "docs/SpdxTool User Guide.pdf"

      - name: Generate Code Quality PDF with Weasyprint
        run: >
          dotnet weasyprint
          --pdf-variant pdf/a-3u
          docs/quality/quality.html
          "docs/SpdxTool Code Quality.pdf"

      - name: Generate Requirements PDF with Weasyprint
        run: >
          dotnet weasyprint
          --pdf-variant pdf/a-3u
          docs/requirements/requirements.html
          "docs/SpdxTool Requirements.pdf"

      - name: Generate Requirements Justifications PDF with Weasyprint
        run: >
          dotnet weasyprint
          --pdf-variant pdf/a-3u
          docs/justifications/justifications.html
          "docs/SpdxTool Requirements Justifications.pdf"

      - name: Generate Trace Matrix PDF with Weasyprint
        run: >
          dotnet weasyprint
          --pdf-variant pdf/a-3u
          docs/tracematrix/tracematrix.html
          "docs/SpdxTool Trace Matrix.pdf"

      # === UPLOAD ARTIFACTS ===
      # This section uploads all generated documentation artifacts.
      # Downstream projects: Add any additional artifact uploads here.

      - name: Upload Document Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: documents
          path: |
            docs/*.pdf
            docs/buildnotes.md
